# 功能规格：Go 版 Agno 重构

**功能分支**：`001-go-agno-rewrite`  
**创建时间**： 2025-11-21  
**状态**： 草稿  
**输入**：用户描述：“由于python的性能问题，再某些场景场景下载这种agetns代理代理服务，存在比较高的性能损耗。go 1.25.1 的版本的版本里面内存gc进行了优化，很时候做这种代理的工作。我们计划使用go语言对进行ptyhon 版本的 agno 进行重构工作。思路和实现架构设计保持一致。只是实现的代码使用golang语言来实现”

## 用户场景与测试 *(必填)*

<!--
  重要：用户故事需按优先级排列，并能够独立测试。
  实现任一故事都应构成可交付的 MVP。
  P1 表示最关键。
-->

### 用户故事 1 - 启动 Go 版代理服务（优先级：P1）

平台/后端工程师希望直接启动 Go 版 Agent/AgentOS，能够以与 Python 版本相同的接口与行为运行代理（聊天、工具调用、会话记忆、工作流步骤），以便在性能敏感场景替换现有服务。

**优先级原因**：这是交付可替代版本的最低可行能力，若无法启动等价服务则无法继续性能验证或迁移。

**独立测试**：在干净环境下填写 `.env` 中的模型密钥，运行启动命令，使用样例代理完成一次对话（含流式响应与工具调用），确认接口、事件与状态持久化与 Python 版本一致。

**验收场景**：

1. **Given** 准备好九家模型的密钥与默认配置，**When** 启动 Go 版代理服务并创建一个具有记忆与工具的代理，**Then** 通过相同的 HTTP/CLI 调用可获得与 Python 版一致的响应格式与会话状态。
2. **Given** 关闭任一工具或记忆模块，**When** 再次调用同一代理，**Then** 服务可继续运行且提供明确的降级提示，不会回落到 Python 进程。

---

### 用户故事 2 - 高并发性能验证（优先级：P2）

运行团队希望在高并发下验证新版本的延迟与资源占用，相比现有 Python 版显著降低性能开销，以决定是否在关键路径替换。

**优先级原因**：性能优化是重构的核心动机，必须以量化数据证明收益。

**独立测试**：使用标准治具在 100 个并发会话下持续 10 分钟，记录 p95 响应时间与峰值内存，比较 Go 与现有版本，验证 Go 版不低于 20% 延迟改善与 25% 内存下降。

**验收场景**：

1. **Given** 设置 100 并发聊天会话（每次 128 token 输入、开启流式），**When** 连续压测 10 分钟，**Then** Go 版的 p95 用户感知响应时间较 Python 版改善 ≥20%，且无错误率上升。
2. **Given** 同步记录内存占用，**When** 压测结束，**Then** Go 版的峰值常驻内存低于 Python 版 ≥25%，并在 GC 周期内无明显抖动导致请求失败。

---

### 用户故事 3 - 行为一致性验证（优先级：P3）

质量与集成团队希望有一套治具与契约测试，验证 Go 版在九家模型供 应商下的输出与 Python 版保持一致（在容差范围内），并能暴露偏差与文档化。

**优先级原因**：没有一致性保障就无法逐步迁移或定位差异，影响上线风险。

**独立测试**：使用从 Python 版生成的固定治具运行契约测试，至少 95% 的用例在设定的 token/文本容差内匹配，偏差需记录并有替代处理。

**验收场景**：

1. **Given** 已生成的治具集（chat/embedding、正常与异常分支），**When** 在 Go 版上运行契约测试，**Then** 各供应商的响应在设定容差内匹配率≥95%，偏差被记录并有说明。
2. **Given** 某供应商缺少必需配置或无响应，**When** 契约测试执行，**Then** 报告中明确指出缺失原因并保持其它供应商的测试可通过。

---

[可按需新增更多故事，并指定优先级]

### 边界场景

- 未提供某个模型供应商的密钥或 endpoint 时，启动与调用需给出明确错误并允许仅启用可用供应商。
- 在高负载或 GC 峰值时，需保证流式响应不被截断，并提供背压/限流提示。
- 当治具与生产配置不一致（如不同模型版本）时，需要在报告中标注并让测试可选择跳过受影响用例。

## 需求 *(必填)*

### 功能需求

- **FR-001**：提供 Go 版代理/OS，可启动、注册代理、会话管理、流式输出与工具调用，接口与 Python 版保持一致的输入/输出结构与错误语义。
- **FR-002**：支持九家模型供应商（ollama、gemini、openai、glm4、openrouter、siliconflow、cerebras、modelscope、groq）的聊天与嵌入能力；缺失功能需在文档中标注并返回可见错误。
- **FR-003**：生成并维护来自 Python 版的治具（正常与异常分支），在 Go 侧以契约测试消费，匹配率需达到 ≥95%，偏差记录在 deviations 报告。
- **FR-004**：在标准压测场景（100 并发、128 token 输入、10 分钟运行）下，p95 响应时间相较 Python 版提升 ≥20%，峰值常驻内存下降 ≥25%，并提供压测报告。
- **FR-005**：无任何运行时依赖 Python（禁止子进程/桥接），启动与测试全由 Go 与标准工具链完成。
- **FR-006**：提供 `.env.example` 与配置说明，覆盖九家供应商的必需/可选变量；缺失密钥时需阻止相关测试并给出明确提示。
- **FR-007**：测试与覆盖率目标：Go 单元、契约、供应商集成测试综合覆盖率 ≥85%，并在 CI 输出覆盖率与契约/压测报告。

### 关键实体 *(若涉及数据则必填)*

- **代理实例/会话**：表示可执行的代理与其会话上下文，包含历史、工具注册、持久化策略。
- **模型供应商适配器**：封装九家供应商的能力、限流与错误映射，暴露统一聊天/嵌入接口。
- **治具与契约用例**：由 Python 版生成的输入/期望输出集合，用于校验行为一致性与偏差记录。
- **性能与覆盖率报告**：压测结果、内存/延迟指标与测试覆盖率数据，用于发布与审查。

## 成功标准 *(必填)*

### 可度量结果

- **SC-001**：完整启动 Go 版代理服务，使用样例代理完成对话与工具调用，接口与响应语义与现有版本一致（人工/自动验证通过）。
- **SC-002**：在标准压测场景下，用户感知 p95 响应时间较现有版本降低 ≥20%，且错误率不高于基线。
- **SC-003**：契约测试匹配率 ≥95%，所有偏差均有文档记录与处理策略。
- **SC-004**：综合测试覆盖率 ≥85%，并产出可审计的压测与覆盖率报告。

## 宪章对齐 *(必填)*

- **纯 Go / 禁止桥接**：全部核心能力（代理/工作流/记忆/工具/MCP）在 `go/internal/{agent,runtime,model,memory,tool}/` 与 `go/pkg/` 落地，严禁以 cgo/子进程调用 `./agno`。
- **模型供应商矩阵**：覆盖 ollama、gemini、openai、glm4、openrouter、siliconflow、cerebras、modelscope、groq 的聊天与嵌入接口；`.env.example` 列出各自必需/可选变量与默认 endpoint。
- **契约/治具与基准**：治具存放于 `specs/001-go-agno-rewrite/contracts/fixtures/`，偏差记录在 `contracts/deviations.md`，压测/覆盖率等报告放在 `artifacts/`；运行测试与基准时不调用 Python。
- **自动化与 Make**：需要 `make fmt lint test providers-test coverage bench gen-fixtures release constitution-check` 等统一入口，CI 复用同名目标、生成并上传报告。
- **测试纪律 + 85% 覆盖率**：Go 单元、契约、供应商集成与基准测试均纳入覆盖率统计，综合 ≥85%，缺口必须补测或缩小改动。
- **密钥与安全**：密钥通过环境变量/secret manager 注入，`.env.example` 仅提供占位与说明，CI/报告中需脱敏输出；缺密钥时测试须安全跳过并给出原因。
