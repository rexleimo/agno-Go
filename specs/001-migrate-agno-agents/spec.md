# 功能规格：agno 核心 agents 能力迁移

**功能分支**：`001-migrate-agno-agents`  
**创建时间**： 2025-11-19  
**状态**： 草稿  
**输入**：用户描述：“迁移agno的所有功能，核心能力是agno的agents供应商实现还有agents的协作模式。agnoOs在agno的核心功能完成后再迁移”

## 用户场景与测试 *(必填)*

### 用户故事 1 - 现有 agno 项目分阶段迁移到 agno-Go（优先级：P1）

作为已经在线上使用 agno 搭建 AI 应用的技术负责人，我希望可以在不改变主要业务逻辑和用户体验的前提下，将当前依赖 agents 供应商与协作模式的核心能力迁移到 agno-Go，使团队可以在可控窗口内完成迁移，并随时对比两套系统的行为差异。

**优先级原因**：若无法保证核心 agents 能力的平滑迁移，现有基于 agno 的产品将难以采用 agno-Go，直接影响业务连续性和后续在 Go 生态上的投入。

**独立测试**：选择若干包含多 agents、不同供应商和协作模式的现有 agno 场景，在 agno-Go 中按迁移指南重建后，对同一批代表性输入执行，并比较关键业务结果和异常行为是否满足预设的一致性标准。

**验收场景**：

1. **Given** 已有一个在线上稳定运行、基于 agno 的 AI 应用，其核心功能依赖多个 agents 和不同供应商，**When** 团队根据迁移指南在 agno-Go 中搭建等价场景并对同一批测试用例执行，**Then** 业务可见结果（如回答内容、任务完成状态、错误提示）在预设容差内保持一致，且不出现额外的致命故障。
2. **Given** 团队为关键业务流程建立了一组对照测试用例，**When** 在 agno 与 agno-Go 上分别执行这些用例，**Then** 所有标记为“必须一致”的用例结果完全一致，标记为“允许轻微差异”的用例差异均在事先定义的范围内。

---

### 用户故事 2 - 新用户快速搭建多智能体协作体验（优先级：P2）

作为新接触 agno 生态的产品/技术负责人，我希望能够基于统一的概念（Agent、供应商、协作模式）在 agno-Go 中快速搭建多智能体协作场景，而不必先学习 Python 版实现细节，这样可以在较短时间内验证业务想法。

**优先级原因**：新用户是否容易上手直接影响 agno-Go 的采用率，如果抽象与 agno 不一致或过于复杂，会显著增加学习成本。

**独立测试**：从零开始，仅依赖文档和示例，在限定时间内搭建一个包含多个 agents 和至少一种协作模式（如串行+并行组合）的场景，并在无外部帮助的情况下完成自测。

**验收场景**：

1. **Given** 一名熟悉业务但对 agno 不熟悉的工程师，**When** 按照文档在 agno-Go 中搭建一个包含 2–3 个 agents、至少一种协作模式和一种外部供应商的场景，**Then** 其在 1 个工作日内即可完成并通过预设的自测用例。
2. **Given** 官方提供的“从零到第一个多智能体场景”的教程，**When** 新用户严格按照步骤操作，**Then** 最终得到的效果与教程中对用户可见行为的描述一致。

---

### 用户故事 3 - 团队扩展自定义 agents 供应商（优先级：P3）

作为需要集成内部系统的技术负责人，我希望可以基于统一协议为 agno 与 agno-Go 扩展自定义 agents 供应商（例如接入内部知识库或业务系统），并清楚理解这些扩展在两种运行时之间可以复用到什么程度，从而降低长期维护成本。

**优先级原因**：企业级场景通常依赖自定义集成。如果扩展方式在 agno 与 agno-Go 之间割裂，将显著增加集成和维护成本，阻碍迁移决策。

**独立测试**：选取一个典型的内部能力（如内部搜索或业务审批），在规范的扩展协议下为 agno 和 agno-Go 分别实现或复用供应商，验证在两端的行为和错误处理方式是否符合预期。

**验收场景**：

1. **Given** 团队基于统一扩展协议实现了一个访问内部系统的自定义供应商，**When** 在 agno 与 agno-Go 中分别将该供应商挂载到同一类 agents 上并执行相同用例，**Then** 能力暴露方式、错误反馈和审计记录在业务语义上保持一致。
2. **Given** 文档中清晰说明了自定义扩展在两种运行时间的复用边界，**When** 新团队按照文档为既有业务开发第二个自定义供应商，**Then** 可以在预期成本内完成实现和联调，且不需要对核心迁移框架做额外改动。

---

### 边界场景

- 当用户使用的某个 agents 供应商尚未在 agno-Go 中完成迁移时，系统应提供明确提示（包括当前支持列表和推荐替代方案），而不是在运行时出现不清晰的错误。
- 当用户依赖的协作模式涉及 agnoOs 或其他高级能力时，系统应清晰告知该能力暂不在 agno-Go 中提供，并指向后续迁移计划或替代实现，而非部分启用导致行为不可预测。
- 当同一产品线在一段时间内同时运行基于 agno 与 agno-Go 的场景时，应约定清晰的流量路由和回滚策略，避免用户在切换过程中看到明显不一致或中断。
- 当底层模型、第三方服务或配置发生变化导致行为差异时，应能通过对照测试场景与 Telemetry 快速归因，而不是只能通过人工排查代码。

## 需求 *(必填)*

### 功能需求

- **FR-001**：平台必须在 agno-Go 中提供与当前 agno 平台等价的一组核心 agents 供应商，首批必须迁移的范围为 cookbook 中已经出现的所有官方与第三方 agents 供应商；若个别供应商无法在首批完成迁移，需在文档中明确标注例外清单和后续计划。
- **FR-002**：平台必须支持当前 agno 中已发布的所有 agents 协作模式（例如串行任务链、并行分工、协调者-执行者、循环决策等），并在相同输入下提供与现有平台在业务语义层面严格等价的协作结果，即在可控的随机性条件下，关键决策路径和最终业务结果应视为一致，任何偏差都需要通过对照测试定位和修复。
- **FR-003**：平台必须定义一套清晰的配置/声明式映射规则，使现有基于 agno 的 agents 与协作配置在迁移到 agno-Go 时，只需进行有限、可机械完成的修改（如命名或结构调整），即可保持业务行为一致。
- **FR-004**：当用户在 agno-Go 中尝试使用尚未迁移的 agnoOs 或其他高级功能时，系统必须提供显式且易懂的提示（包含当前支持范围与推荐替代方案），而不是出现静默失败或难以理解的错误。
- **FR-005**：平台必须提供一组可复用的对照验证场景（基于代表性业务流程或官方示例），用于在 agno 与 agno-Go 间对比相同行为，并可作为自动化回归测试的一部分，以验证迁移前后核心能力的一致性。
- **FR-006**：平台必须提供以业务视角观察 agents 协作过程的能力，例如查看任务在不同 agents 间的分配、关键决策节点和错误传播路径，以便迁移过程中快速定位行为差异。
- **FR-007**：平台必须定义统一的扩展协议，使团队能够按照同一套约定新增自定义 agents 供应商或协作模式，并在文档中说明这些扩展在 agno 与 agno-Go 之间可以共享到何种程度；设计目标是在不牺牲各自运行时优势的前提下，实现“一次扩展定义，尽可能两端复用”，仅在必要时才要求分别实现。
- **FR-008**：平台必须支持分阶段迁移策略，即允许在同一产品线中同时运行基于 agno 与 agno-Go 的场景，并提供清晰的路由、灰度发布与回滚指导，以降低迁移风险。

### 关键实体 *(若涉及数据则必填)*

- **Agent（智能体）**：代表一个具备明确角色和能力的执行单元，可以结合特定供应商、知识和工具来完成用户任务。关键属性包括角色设定、允许使用的供应商/工具、输入输出约束等。
- **Agents 供应商（Provider）**：代表底层能力提供方，例如通用大模型服务、向量检索服务或业务系统接口。关键属性包括能力类型、配置参数（如模型选择、限制规则）以及错误反馈语义。
- **协作模式/工作流**：描述多个 agents 之间的分工、顺序与决策规则，例如由协调者分配任务、并行子任务合并、循环改写与审阅等。关键属性包括参与 agents 列表、触发条件和终止条件。
- **会话/任务（Session/Task）**：代表一次完整的用户任务或对话流程，贯穿多个 agents 的协作，包含上下文、历史记录和最终业务结果，用于对照验证不同运行时的行为。
- **对照测试场景**：为了跨运行时比较而定义的一组固定输入、期望行为和验证规则，可用于回归测试和问题复现。

### 假设与范围

- 假设：本阶段优先迁移与 agents 供应商和协作模式直接相关的能力（例如多模型接入、工具调用、知识检索、会话管理），评估、观测、外部集成等能力可在后续阶段通过独立规格补齐。
- 假设：agnos 相关功能（包括 agent_os 目录中的能力）明确不在本规格范围内，将在 agno 核心能力稳定后通过单独规格进行迁移。
- 假设：允许在迁移初期保留少量仅在 agno 端存在的高级功能，只要对用户有清晰说明且不影响主路径体验。
- 假设：默认目标用户为已有 agno 使用经验的团队和新接入 agno-Go 的应用团队，两者均具备基本测试和验证能力。
- 范围界定：本规格只定义功能对齐和体验一致性的目标，不约束具体实现细节（如内部线程模型、缓存策略或具体第三方 SDK 的选型）。

## 成功标准 *(必填)*

### 可度量结果

- **SC-001**：官方选定的一组代表性 agno 示例（至少覆盖 80% 当前 agents 与协作场景）在 agno-Go 上迁移后，其关键业务流程的通过率达到 95% 及以上（按预先定义的验收用例验证）。
- **SC-002**：对比迁移前后，使用这些场景的最终用户在主要任务上的完成率不低于迁移前，并且至少 80% 的用户在体验访谈或问卷中表示“几乎感觉不到差异或略有提升”。
- **SC-003**：迁移窗口期内，与 agents 行为不一致相关的线上严重故障（导致任务完全无法完成）不超过全部发布的 2%，且所有此类故障均可通过对照测试场景重现并通过修复后的回归验证关闭。
- **SC-004**：针对新团队，从零开始基于文档搭建一个包含多个 agents 和至少一种协作模式的完整场景，平均用时不超过 1 个工作日，并且无需依赖原 agno 代码库即可完成。

## 宪章对齐 *(必填)*

- **Python 参考实现与行为对齐**：本规格以 Python 仓库中 `agno/libs/agno/agno` 下的模块作为行为基准，重点关注 `agent/`、`workflow/`、`team/`、`knowledge/`、`memory/`、`tools/`、`session/` 等子模块，以及 `cookbook/agents`、`cookbook/workflows`、`cookbook/teams` 中的代表性示例。要求 agno-Go 在相同输入、配置和上下文下的行为与这些参考实现保持业务语义一致，并在文档中列出允许差异的边界（例如模型不确定性导致的回答内容差异）。
- **Go API 设计与包结构**：Go 侧目标是形成清晰的包结构（例如 `go/agent`、`go/workflow`、`go/providers`、`go/knowledge`、`go/session` 等命名空间），对外暴露与 Python 抽象对应的概念（如 Agent、Provider、Workflow、Team），同时允许根据 Go 语言特性做必要的语义调整。对于任何与 Python 行为不完全一致的地方，需要在规格中明确记录差异原因、对现有使用者的影响以及推荐迁移路径。
- **跨语言测试纪律与 85% 覆盖率**：围绕本规格涉及的能力，建立跨语言对照测试套件：相同输入分别在 Python agno 和 agno-Go 上执行，对比关键行为和结果。要求 Go 侧相关包的单元与集成测试覆盖率不低于 85%，并在开发流程中将这些对照测试纳入必跑项，以防止未来变更引入跨语言行为偏差。
- **性能与资源使用基线**：为典型 agents 场景（如单 agent 问答、多 agent 协作、长对话等）定义可观测的性能与资源使用基线，例如迁移后端到端响应时间和资源占用与 Python 版本保持同一数量级，并在文档中说明何种差异是可接受的（如部分场景更快、部分稍慢但仍在用户可接受范围内）。如需引入基准测试，应指明所用场景、指标和结果记录位置，用于后续回归比较。
- **安全、配置与 Telemetry**：梳理本规格涉及的配置项（如模型选择、密钥管理、超时与重试策略）、敏感信息（如访问凭据、业务数据）以及外部依赖（如模型服务和向量库），确保在 agno-Go 中沿用安全最佳实践，并避免通过日志、调试输出或 Telemetry 泄露敏感信息。需要定义关键 Telemetry 事件（例如请求开始/结束、供应商错误、协作失败），以支撑迁移期的观测与回溯。
- **文档与示例对齐**：列出需要更新或新增的文档与示例范围，包括 agno 仓库中的 `cookbook/agents`、`cookbook/workflows`、`cookbook/teams`、`cookbook/knowledge` 以及 `cookbook/agent_os`（后者仅作为未来迁移对象标记）。要求为 agno-Go 提供对应的指南与示例，使用户能够清晰理解哪些功能已经完成迁移、如何在新环境中配置 agents 与协作模式，以及尚未迁移的能力和计划节奏。

## Clarifications

### Session 2025-11-19

- Q: 首批必须迁移的 agents 供应商范围？仅官方支持，还是包含 cookbook 中全部第三方供应商？ → A: 首批覆盖 cookbook 中已经出现的所有官方与第三方 agents 供应商，如有无法在首批完成的供应商需在文档中列出例外和后续计划。
- Q: 是否要求行为“严格等价”（决策路径一致），还是只要求“业务结果等价”（输出在可接受误差范围内一致）？ → A: 要求在可控随机性条件下尽可能行为严格等价，关键决策路径和业务结果视为一致，偏差应通过对照测试发现并修复。
- Q: 自定义扩展是否需要在两个运行时间“一次开发、两端复用”，还是允许为不同运行时分别实现？ → A: 设计目标是在不牺牲各自运行时优势的前提下，实现一次扩展定义尽可能两端复用，仅在必要时才要求分别实现。
